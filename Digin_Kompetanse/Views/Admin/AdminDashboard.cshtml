@model IEnumerable<Digin_Kompetanse.Models.ViewModels.AdminViewModel>

@{
ViewData["Title"] = "Administrasjonspanel";
var fagomrader = ViewBag.Fagomrader as List<string> ?? new List<string>();
var kompetanser = ViewBag.Kompetanser as List<string> ?? new List<string>();

var valgtFagomrade = Context.Request.Query["fagomrade"].ToString();
var valgtKompetanse = Context.Request.Query["kompetanse"].ToString();
var valgtUnder = Context.Request.Query["underkompetanse"].ToString();
}

<div class="admin-dashboard">
    <h2>@ViewData["Title"]</h2>

    <div class="step">
        <form method="get" asp-action="AdminDashboard">
            <div class="filter-bar">
                <div>
                    <label for="fagomrade" class="form-label fw-semibold mb-1">Fagområde</label>
                    <select id="fagomrade" name="fagomrade" class="form-select form-select-sm">
                        <option value="">Alle</option>
                        @foreach (var fag in fagomrader)
                        {
                            <option value="@fag" selected="@(valgtFagomrade == fag)">@fag</option>
                        }
                    </select>
                </div>
                <div>
                    <label for="kompetanse" class="form-label fw-semibold mb-1">Kompetanse</label>
                    <select id="kompetanse" name="kompetanse" class="form-select form-select-sm">
                        <option value="">Alle</option>
                        @foreach (var komp in kompetanser)
                        {
                            <option value="@komp" selected="@(valgtKompetanse == komp)">@komp</option>
                        }
                    </select>
                </div>
                <div>
                    <label for="underkompetanse" class="form-label fw-semibold mb-1">Underkompetanse</label>
                    <select id="underkompetanse" name="underkompetanse" class="form-select form-select-sm">
                        <option value="">Alle</option>
                        @foreach (var under in ViewBag.Underkompetanser as List<string> ?? new List<string>())
                        {
                            <option value="@under" selected="@(valgtUnder == under)">@under</option>
                        }
                    </select>
                </div>
                <div>
                    <label class="form-label invisible">Filtrer</label>
                    <button type="submit"
                            class="btn btn-digin btn-sm filter-btn-filtrer d-flex align-items-center justify-content-center">
                        <i class="bi bi-search me-1"></i> Filtrer
                    </button>
                </div>
                <div>
                    <label class="form-label invisible">Tøm</label>
                    <a asp-action="AdminDashboard"
                       class="btn btn-outline-digin btn-sm filter-btn-tom d-flex align-items-center justify-content-center">
                        <i class="bi bi-x-circle me-1"></i> Tøm
                    </a>
                </div>
                <div>
                    <label class="form-label invisible">Eksporter</label>
                    <a asp-action="ExportCsv"
                       asp-controller="Admin"
                       asp-route-fagomrade="@valgtFagomrade"
                       asp-route-kompetanse="@valgtKompetanse"
                       asp-route-underkompetanse="@valgtUnder"
                       class="btn btn-success btn-sm filter-btn-eksporter d-flex align-items-center justify-content-center">
                        <i class="bi bi-file-earmark-spreadsheet me-1"></i> Eksporter
                    </a>
                </div>

            </div>
        </form>
    </div>
    <div class="step">
        <h5 class="center"><strong>Innsendinger</strong></h5>

        @{
            var grupper = Model!
                .GroupBy(m => new {
                    Navn = m.BedriftNavn ?? "(Ukjent bedrift)",
                    Epost = m.Epost ?? "(Ukjent epost)"
                })
                .OrderBy(g => g.Key.Navn)
                .ThenBy(g => g.Key.Epost)
                .ToList();
        }

        @if (!grupper.Any())
        {
            <div class="text-muted py-4">Ingen treff på valgt filter.</div>
        }
        else
        {
            foreach (var gruppe in grupper)
            {
                var navn = gruppe.Key.Navn;
                var epost = gruppe.Key.Epost;
                
                <div class="admin-div">
                    <p style="color: #555;" class="mb-0">@navn: @epost</p>
                    <form asp-action="DeleteBedrift"
                          asp-controller="Admin"
                          asp-route-id="@gruppe.First().BedriftId"
                          method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <button type="submit"
                                class="btn btn-sm btn-outline-danger admin-delete"
                                onclick="return confirm('Slette denne bedriften og alle tilknyttede kompetanser?');">
                            Slett bedrift
                        </button>
                    </form>
                </div>
                    
                <div class="table-responsive">
                    <table class="table table-striped align-middle text-center mb-0">
                        <thead class="table-light">
                        <tr>
                            <th>Fagområde</th>
                            <th>Kompetanse</th>
                            <th>Underkompetanse</th>
                            <th>Beskrivelse</th>
                        </tr>
                        </thead>
                        <tbody>
                        @foreach (var item in gruppe)
                        {
                            <tr>
                                <td>@item.Fagområde</td>
                                <td>@item.KompetanseKategori</td>
                                <td>@(string.IsNullOrEmpty(item.UnderKompetanse) ? "-" : item.UnderKompetanse)</td>
                                <td>@(string.IsNullOrEmpty(item.Beskrivelse) ? "-" : item.Beskrivelse)</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            }
        }
    </div>
</div>


